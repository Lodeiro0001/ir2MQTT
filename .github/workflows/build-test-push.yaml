name: Build, Test & Push
on:
  workflow_dispatch: {}
  push:
    branches:
      - '**'  # all branches

jobs:
  buildTestPush:
    name: Build, Test & Push
    runs-on: ubuntu-latest

    steps:
      # Setup
      - name: Checkout
        uses: actions/checkout@master
        with:
          fetch-depth: 1
      - name: Install wait-for-it
        run: apt-get -yq install wait-for-it

      # Build
      - name: Docker cache
        uses: satackey/action-docker-layer-caching@v0.0.11
        continue-on-error: true
      - name: Docker build
        run: docker build . -t ir2mqtt

      # Test
      - name: (test) Start container
        run: docker run --rm -d --name=ir2mqtt --net=host ir2mqtt
      - name: (test) Wait for port
        run: wait-for-it --host=localhost --port=8420 --timeout=15
      - name: (test) Access the frontend
        run: curl -f http://localhost:8420
